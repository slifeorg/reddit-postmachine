{"version":3,"file":"rc-page.js","sources":["../../src/sailor/rc-page.js"],"sourcesContent":["if (window.rc_page || !/reddit\\.com/.test(location.hostname)) {\n  // Already initialized OR wrong domain\n  console.log('not')\n\n} else {\n  class RedditSpace {\n    constructor() {\n      this.pageReadyPromise = null;\n      this.SELECTORS = {\n        app: 'shreddit-app', // Reddit's main app container\n      };\n      this.lastCheckTime = 0;\n      this.checkInterval = 500;\n      this.maxWaitTime = 15000; // 15s timeout\n      this.accountId = null;\n      this.isReady = false;\n      this.lastActivationAttempt = 0;\n      this.activationCooldown = 2000; // Anti-spam\n    }\n\n    log = async (operation, message, level = 'log', details = {}) => {\n      try {\n        const displayName = window.rc_page?.seren?.name || 'BleedingHeart_108';\n        console[level](`[display-name=\"${displayName}\"] ${operation}: ${message}`, details);\n        chrome.runtime.sendMessage({\n          action: 'LOG',\n          operation,\n          message,\n          level,\n          details: { displayName, ...details }\n        }).catch(() => {});\n      } catch (_) {}\n    };\n\n    isPageReady = () => {\n      try {\n        const now = Date.now();\n        if (now - this.lastCheckTime < this.checkInterval) return this.isReady;\n        this.lastCheckTime = now;\n\n        const app = document.querySelector(this.SELECTORS.app);\n        this.isReady = !!app;\n        return this.isReady;\n      } catch {\n        this.isReady = false;\n        return false;\n      }\n    };\n\n    waitForPageReady = async (maxWaitTimeMs = this.maxWaitTime) => {\n      if (this.pageReadyPromise) return this.pageReadyPromise;\n      this.pageReadyPromise = new Promise((resolve, reject) => {\n        const startTime = Date.now();\n        const checkPage = () => {\n          if (this.isPageReady()) {\n            this.log('Reddit-Space', 'Page ready', 'debug');\n            resolve(true);\n            return;\n          }\n          if (Date.now() - startTime > maxWaitTimeMs) {\n            this.log('Reddit-Space', 'Page failed to load within timeout', 'error');\n            reject(new Error('Timeout'));\n            return;\n          }\n          setTimeout(checkPage, this.checkInterval);\n        };\n        checkPage();\n      });\n      return this.pageReadyPromise;\n    };\n\n    getCurrentAccountId = async () => {\n      try {\n        if (!this.isPageReady()) {\n          console.warn('Reddit-Space: Page not ready for user fetch');\n          return null;\n        }\n\n        const response = await fetch('https://www.reddit.com/api/v1/me.json', {\n          credentials: 'include',\n          mode: 'cors'\n        });\n\n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}: Failed to fetch user info`);\n        }\n\n        const data = await response.json();\n        const displayName = data.name || 'BleedingHeart_108';\n        const accountId = data.id || displayName;\n\n        window.rc_page.seren = {\n          name: displayName,\n          account_id: accountId\n        };\n\n        console.info('CurrentAccount:', displayName);\n        return accountId || null;\n      } catch (error) {\n        console.warn('Reddit-Space: getCurrentAccountId error:', error.message);\n        //window.rc_page.seren = { name: 'BleedingHeart_108', account_id: 'Unknown' };\n        console.info('CurrentAccount: BleedingHeart_108 (error: ' + error.message + ')');\n        return null;\n      }\n    };\n\n    activatePage = async () => {\n      try {\n        const now = Date.now();\n        if (now - this.lastActivationAttempt < this.activationCooldown) {\n          return { success: this.isReady, message: 'Cooldown', accountId: this.accountId };\n        }\n\n        this.lastActivationAttempt = now;\n        await this.waitForPageReady();\n        this.accountId = await this.getCurrentAccountId() || 'Unknown';\n        this.isReady = true;\n\n        this.log('Reddit-Space', `Activated: ${this.accountId}`, 'info');\n        return { success: true, message: 'Activated', accountId: this.accountId };\n      } catch (error) {\n        this.isReady = false;\n        return { success: false, message: error.message, accountId: null };\n      }\n    };\n  }\n\n  const RedditPage = (() => {\n    let instance = null;\n\n    class RedditPageImpl extends RedditSpace {\n      constructor() {\n        super();\n      }\n\n      static init() {\n        if (!instance) instance = new RedditPageImpl();\n        return Promise.resolve(instance);\n      }\n\n      resetPageReadyState() {\n        this.pageReadyPromise = null;\n        this.isReady = false;\n      }\n\n      reloadAndActivate() {\n        this.resetPageReadyState();\n        return this.activatePage(); // Без reload для SPA\n      }\n\n      async safeActivateAndLoad() {\n        await this.activatePage();\n        return { success: true, message: 'Activated' };\n      }\n    }\n\n    window.rc_page = {};\n    RedditPageImpl.init().then(instance => {\n      window.rc_page.RedditPage = instance;\n      window.rc_page.safeActivateAndLoad = () => instance.safeActivateAndLoad();\n    });\n\n    return RedditPageImpl;\n  })();\n\n  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n    if (!window.rc_page?.RedditPage) {\n      sendResponse({ success: false, message: 'Not initialized' });\n      return;\n    }\n\n    const page = window.rc_page.RedditPage;\n\n    switch (request.action) {\n      case 'CHECK_PAGE_READY':\n        sendResponse({ isReady: page.isPageReady(), accountId: page.accountId });\n        break;\n      case 'ACTIVATE_PAGE':\n        page.activatePage().then(sendResponse);\n        return true;\n      case 'SAFE_ACTIVATE_AND_LOAD':\n        page.safeActivateAndLoad().then(sendResponse);\n        return true;\n      case 'RESET_PAGE_STATE':\n        page.resetPageReadyState();\n        sendResponse({ success: true });\n        break;\n      case 'RELOAD_AND_ACTIVATE':\n        page.reloadAndActivate().then(sendResponse);\n        return true;\n      case 'GET_ACCOUNT_ID':\n        page.getCurrentAccountId().then(accountId => {\n          sendResponse({ success: !!accountId, accountId });\n        });\n        return true;\n      default:\n        sendResponse({ success: true });\n    }\n  });\n\n  // Auto-init\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => RedditPage.init());\n  } else {\n    RedditPage.init();\n  }\n}\n"],"names":["instance"],"mappings":"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"}